name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-backend:
    name: Build & Test Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          cache-dependency-path: backend/pom.xml

      - name: Build & verify
        run: mvn verify -B -Dspring.profiles.active=test

      - name: Upload JaCoCo coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/target/site/jacoco/
          retention-days: 7

      - name: Upload surefire test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: backend/target/surefire-reports/
          retention-days: 7

  build-frontend:
    name: Build & Test Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --ci --coverage

      - name: Build production bundle
        run: npx ng build --configuration=production

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          # Verify key is readable
          ssh-keygen -y -f ~/.ssh/deploy_key > /dev/null

      - name: Sync project files to VPS
        run: |
          rsync -avz --delete \
            --exclude node_modules \
            --exclude target \
            --exclude .git \
            --exclude .angular \
            --exclude dist \
            --exclude '.env*' \
            --exclude '*.zip' \
            -e "ssh -i ~/.ssh/deploy_key" \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/sgcd-pm/

      - name: Write production environment file
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cat > /opt/sgcd-pm/.env" <<'ENVEOF'
          ${{ secrets.ENV_PROD_CONTENTS }}
          ENVEOF

      - name: Build and start containers
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cd /opt/sgcd-pm && docker compose -f docker-compose.prod.yml up --build -d"

      - name: Health check
        run: |
          echo "Waiting for services to start..."
          sleep 15

          echo "Checking frontend..."
          curl --fail --retry 5 --retry-delay 5 --retry-all-errors \
            -o /dev/null -s -w "Frontend: HTTP %{http_code}\n" \
            http://${{ secrets.VPS_HOST }}/

          echo "Checking API..."
          HTTP_CODE=$(curl --retry 5 --retry-delay 5 --retry-all-errors \
            -o /dev/null -s -w "%{http_code}" \
            -X POST -H "Content-Type: application/json" -d '{}' \
            http://${{ secrets.VPS_HOST }}/api/v1/auth/login)
          echo "API: HTTP $HTTP_CODE"
          # Login with empty body returns 400/401 â€” any response means the API is up
          if [ "$HTTP_CODE" = "000" ]; then
            echo "API did not respond"
            exit 1
          fi
